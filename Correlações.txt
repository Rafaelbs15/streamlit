import streamlit as st
import pandas as pd
import altair as alt
from scipy.stats import linregress
import numpy as np

st.set_page_config(page_title="Dashboard SARESP", 
                   page_icon=":bar_chart:",
                   layout="wide")

st.title("Dashboard de Análise do SARESP")

# Carregar dados direto do Google Planilhas
@st.cache_data
def carregar_dados(url):
    return pd.read_csv(url)

# URLs para os arquivos do Google Drive
url_simulado = "https://drive.google.com/file/d/1EMEZAK_VRjUpqWFx00MlSiC3_3_rWUpA/view?usp=drive_link"
url_raca_jundiai = "https://drive.google.com/file/d/1eNdo3xHRjUJ6i5EOHdARqQM2NIuusode/view?usp=drive_link"
url_raca_sul1 = "https://drive.google.com/file/d/1iez8-jFuHRcuPEU0XdYGT3AGTu-kDl_6/view?usp=drive_link"
url_saresp_sul1 = "https://drive.google.com/file/d/1xuMPPGO2bOo443GQbsoVuJEolojULRvk/view?usp=drive_link"
url_saresp_jundiai = "https://drive.google.com/file/d/1EViJbfPdR51-SgbWvVKfUIQ1m9ltfYkf/view?usp=drive_link"

# Carregar os dados
simulado_df = carregar_dados(url_simulado)
raca_jundiai_df = carregar_dados(url_raca_jundiai)
raca_sul1_df = carregar_dados(url_raca_sul1)
saresp_sul1_df = carregar_dados(url_saresp_sul1)
saresp_jundiai_df = carregar_dados(url_saresp_jundiai)

# Combine os dados de acordo com a DE ou localidade, se necessário
# Exemplo de combinação de dados (ajuste conforme a sua necessidade)
df_combinado = pd.concat([saresp_sul1_df, saresp_jundiai_df])

# Sidebar de navegação
st.sidebar.title("Navegação")

# Filtro por Diretoria de Ensino ou localidade
if 'DE' in df_combinado.columns:
    lista_de = sorted(df_combinado['DE'].unique())
    de_selecionada = st.sidebar.selectbox("Escolha a Diretoria de Ensino", lista_de)
    df_filtrado = df_combinado[df_combinado['DE'] == de_selecionada]
else:
    df_filtrado = df_combinado.copy()

page = st.sidebar.selectbox("Escolha a página", ["Análise por Raça", "Comparativo Simulado x SARESP"])

if page == "Análise por Raça":
    st.header(f"Análise Geral por Raça - DE: {de_selecionada}")

    if 'Race' in df_filtrado.columns and 'SARESP' in df_filtrado.columns:
        col1, col2 = st.columns(2)

        with col1:
            st.subheader("Média das Notas por Raça")
            media_por_raca = df_filtrado.groupby('Race')['SARESP'].mean().reset_index()

            bar_chart_race = alt.Chart(media_por_raca).mark_bar().encode(
                x=alt.X('Race:N', title='Raça'),
                y=alt.Y('SARESP:Q', title='Nota Média SARESP'),
                tooltip=['Race', 'SARESP']
            ).properties(title="Notas Médias por Raça")

            st.altair_chart(bar_chart_race, use_container_width=True)

        with col2:
            st.subheader("Distribuição de Notas por Raça")
            boxplot_race = alt.Chart(df_filtrado).mark_boxplot().encode(
                x='Race:N',
                y='SARESP:Q',
                color='Race:N'
            ).properties(title="Boxplot das Notas por Raça")

            st.altair_chart(boxplot_race, use_container_width=True)

        st.markdown("""
        **Interpretação:**
        Os gráficos mostram como as médias e a distribuição das notas do SARESP variam entre os diferentes grupos raciais dentro da DE selecionada.
        """)
    else:
        st.warning("As colunas 'Race' e 'SARESP' precisam estar presentes no dataset.")

elif page == "Comparativo Simulado x SARESP":
    st.title(f"Comparativo entre Nota do Simulado e Nota do SARESP - DE: {de_selecionada}")

    if 'Simulado' in df_filtrado.columns and 'SARESP' in df_filtrado.columns:
        st.subheader("Dispersão entre Nota do Simulado e Nota do SARESP com Linha de Regressão")

        x = df_filtrado['Simulado']
        y = df_filtrado['SARESP']
        slope, intercept, r_value, p_value, std_err = linregress(x, y)
        r_squared = r_value ** 2

        regression_line = pd.DataFrame({
            'Simulado': np.linspace(x.min(), x.max(), 100)
        })
        regression_line['SARESP_Pred'] = slope * regression_line['Simulado'] + intercept

        scatter = alt.Chart(df_filtrado).mark_circle(size=60).encode(
            x='Simulado',
            y='SARESP',
            tooltip=['Simulado', 'SARESP']
        )

        line = alt.Chart(regression_line).mark_line(color='red').encode(
            x='Simulado',
            y='SARESP_Pred'
        )

        st.altair_chart((scatter + line).interactive(), use_container_width=True)

        st.markdown(f"""
        **Coeficiente de Correlação (r):** {r_value:.2f}  
        **Coeficiente de Determinação (R²):** {r_squared:.2f}  
        **Equação da Regressão:** SARESP = {slope:.2f} * Simulado + {intercept:.2f}
        """)

        st.info("**Interpretação:**\n"
                f"O valor de R² indica que aproximadamente **{r_squared*100:.1f}%** da variação nas notas do SARESP "
                "pode ser explicada pelas notas do Simulado por meio de uma regressão linear simples.")

        st.subheader("Distribuição das Notas")
        col1, col2 = st.columns(2)

        with col1:
            hist_simulado = alt.Chart(df_filtrado).mark_bar().encode(
                alt.X("Simulado", bin=True),
                y='count()'
            ).properties(title="Distribuição - Simulado")
            st.altair_chart(hist_simulado, use_container_width=True)

        with col2:
            hist_saresp = alt.Chart(df_filtrado).mark_bar().encode(
                alt.X("SARESP", bin=True),
                y='count()'
            ).properties(title="Distribuição - SARESP")
            st.altair_chart(hist_saresp, use_container_width=True)

    else:
        st.warning("As colunas 'Simulado' e 'SARESP' não foram encontradas nos dados.")
